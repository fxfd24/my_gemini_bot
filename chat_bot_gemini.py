"""### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫"""
import telebot
from google import genai

"""### –£–∫–∞–∑–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ (–±–æ—Ç –∏ –ò–ò –∞–≥–µ–Ω—Ç)"""

TOKEN = '8183367130:AAHw9eqIZTHV13fd6yxiIcceZ4ImF75AFFs'
api_key = "AIzaSyAPRgK8jXW2gUFvzqnyIW7qoLFejB2z4Ic"
bot = telebot.TeleBot(TOKEN)
client = genai.Client(api_key = api_key)

"""### –•–µ–Ω–¥–ª–µ—Ä –∫–æ–º–∞–Ω–¥—ã /start"""

# –†–µ–∞–∫—Ü–∏—è –±–æ—Ç–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@bot.message_handler(commands=['start'])
def on_start(message):
  bot.send_message(message.chat.id, f'–ü—Ä–∏–≤–µ—Ç, —è —á–∞—Ç –±–æ—Ç!')
  bot.send_message(message.chat.id, f'–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—É /text')
  bot.send_message(message.chat.id, f'–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—É /img')

"""### –•–µ–Ω–¥–ª–µ—Ä –∫–æ–º–∞–Ω–¥—ã /text (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞)"""

# –†–µ–∞–∫—Ü–∏—è –±–æ—Ç–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥—É /text
@bot.message_handler(commands=['text'])
def on_text_generation(message):
    chat_id = message.chat.id
    user_id = message.from_user.id

    # 1. –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–æ–º–ø—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    # message.text —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é —Å—Ç—Ä–æ–∫—É, –Ω–∞–ø—Ä–∏–º–µ—Ä "/text –ü—Ä–∏–≤–µ—Ç, –º–∏—Ä!"
    # –£–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—É '/text ' –∏–∑ –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫–∏
    command_parts = message.text.split(maxsplit=1) # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –ø–µ—Ä–≤–æ–º—É –ø—Ä–æ–±–µ–ª—É

    if len(command_parts) < 2 or not command_parts[1].strip():
        # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /text –Ω–∏—á–µ–≥–æ –Ω–µ—Ç –∏–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª—ã
        bot.reply_to(message, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /text.\n–ü—Ä–∏–º–µ—Ä: `/text –ù–∞–ø–∏—à–∏ —Å—Ç–∏—Ö –æ –ª–µ—Ç–µ`")
        return # –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

    prompt = command_parts[1].strip() # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –ø–æ –∫—Ä–∞—è–º

    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –±–æ—Ç "–¥—É–º–∞–µ—Ç"
    thinking_message = bot.reply_to(message, "üß† –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç–≤–µ—Ç...")

    try:
        # 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–º–ø—Ç –≤ GenAI
        response = client.models.generate_content(
            model="gemini-2.5-pro-exp-03-25",
            contents=prompt,
        )

        # 3. –ü–æ–ª—É—á–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        generated_text = response.text

        # 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–î—É–º–∞—é..." –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç - —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –ª—É—á—à–µ
        bot.edit_message_text(chat_id=chat_id,
                              message_id=thinking_message.message_id,
                              text=generated_text)

    except Exception as e:
        # 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–±–ª–µ–º
        # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± –æ—à–∏–±–∫–µ
        try:
            bot.edit_message_text(chat_id=chat_id,
                                  message_id=thinking_message.message_id,
                                  text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.")
        except Exception as edit_error: # –ï—Å–ª–∏ –¥–∞–∂–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
             bot.reply_to(message, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.")

"""### –•–µ–Ω–¥–ª–µ—Ä –∫–æ–º–∞–Ω–¥—ã /img (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–∏–Ω–æ–∫)"""

# –†–µ–∞–∫—Ü–∏—è –±–æ—Ç–∞ –Ω–∞ –∫–æ–º–∞–Ω–¥—É /img
@bot.message_handler(commands=['img'])
def on_img_generation(message):
    chat_id = message.chat.id
    user_id = message.from_user.id

    # 1. –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–æ–º–ø—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    # message.text —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é —Å—Ç—Ä–æ–∫—É, –Ω–∞–ø—Ä–∏–º–µ—Ä "/img –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–∞—Ä—Ç–∏–Ω–∫—É –≥–¥–µ –∞–∫—É–¥–∞ —Å—Ç–æ–∏—Ç –Ω–∞ –ø–ª—è–∂–µ –≤ –∫—Ä–æ—Å—Å–æ–≤–∫–∞—Ö –Ω–∞–π–∫"
    # –£–±–∏—Ä–∞–µ–º –∫–æ–º–∞–Ω–¥—É '/img ' –∏–∑ –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫–∏
    command_parts = message.text.split(maxsplit=1) # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –ø–µ—Ä–≤–æ–º—É –ø—Ä–æ–±–µ–ª—É

    if len(command_parts) < 2 or not command_parts[1].strip():
        # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /img –Ω–∏—á–µ–≥–æ –Ω–µ—Ç –∏–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª—ã
        bot.reply_to(message, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /img.\n–ü—Ä–∏–º–µ—Ä: /img –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∫–∞—Ä—Ç–∏–Ω–∫—É –≥–¥–µ –∞–∫—É–ª–∞ —Å—Ç–æ–∏—Ç –Ω–∞ –ø–ª—è–∂–µ –≤ –∫—Ä–æ—Å—Å–æ–≤–∫–∞—Ö –Ω–∞–π–∫")
        return # –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

    prompt = command_parts[1].strip() # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –ø–æ –∫—Ä–∞—è–º

    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –±–æ—Ç "–¥—É–º–∞–µ—Ç"
    thinking_message = bot.reply_to(message, "üß† –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...")

    try:
        # 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–º–ø—Ç –≤ GenAI
        response = client.models.generate_content(
            model="gemini-2.0-flash-exp-image-generation",
            contents=prompt,
            config=types.GenerateContentConfig(
              response_modalities=['Text', 'Image']
            )
        )

        # 3. –ü–æ–ª—É—á–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        for part in response.candidates[0].content.parts:
          if part.text is not None:
            print(part.text)
          elif part.inline_data is not None:
            image = Image.open(BytesIO((part.inline_data.data)))
            image.save('gemini.png')

        # 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–î—É–º–∞—é..." –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç - —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –ª—É—á—à–µ
        bot.edit_message_text(chat_id=chat_id,
                              message_id=thinking_message.message_id,
                              text=f"–ö–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É {prompt}")

        bot.send_photo(chat_id=chat_id, photo=open('gemini.png', 'rb'))

    except Exception as e:
        # 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–±–ª–µ–º
        # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± –æ—à–∏–±–∫–µ
        try:
            bot.edit_message_text(chat_id=chat_id,
                                  message_id=thinking_message.message_id,
                                  text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.")
        except Exception as edit_error: # –ï—Å–ª–∏ –¥–∞–∂–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
             bot.reply_to(message, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.")

"""### –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""

# –†–µ–∞–∫—Ü–∏—è –±–æ—Ç–∞ –Ω–∞ –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
@bot.message_handler(content_types=['text'])
def text_answer(message):
  bot.send_message(message.chat.id, f'–ù–µ –ø–æ–Ω–∏–º–∞—é —Ç–µ–±—è. –ù–∞—á–Ω–∏ —Å –Ω–∞—á–∞–ª–∞ --> /start')

"""### –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω—è—è —è—á–µ–π–∫–∞)"""

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.polling(none_stop=True)